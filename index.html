<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Number Mind Game - Multiplayer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Supabase JS Client (UMD Build) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(165, 180, 252, 0.5); border-radius: 20px; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pop { 0% { transform: scale(0.9); opacity: 0; } 50% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }
        .animate-pop { animation: pop 0.2s ease-out; }
    </style>
</head>
<body style="margin: 0; background-color: #E6E6FA;">
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION ---
        const SUPABASE_URL = "https://hwddafpoimrurdrhgtna.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3ZGRhZnBvaW1ydXJkcmhndG5hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNjAwMzQsImV4cCI6MjA3OTczNjAzNH0.MumrXlZpwFO69cg0mReggukRN3zrg6Fv0PVh65vl75I";

        // --- GLOBAL VARS ---
        let supabaseClient = null;

        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS ---
        const Icons = {
            Trophy: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" /><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" /><path d="M4 22h16" /><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" /><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" /><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" /></svg>,
            RefreshCw: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 21h-5v-5" /></svg>,
            AlertCircle: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></svg>,
            Play: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3" /></svg>,
            User: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Users: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Copy: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            Home: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            PlusSquare: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="12" x2="12" y1="8" y2="16"/><line x1="8" x2="16" y1="12" y2="12"/></svg>,
            ArrowLeft: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            LogIn: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>,
            Check: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>,
            Eye: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            Info: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
        };

        // --- UTILS ---
        const generateSecretNumber = () => {
            const digits = ['1', '2', '3', '4', '5', '6', '7', '8', '9'];
            for (let i = digits.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [digits[i], digits[j]] = [digits[j], digits[i]];
            }
            return digits.slice(0, 4).join('');
        };
        const validateInput = (val) => {
            if (val.length !== 4) return "Input must be exactly 4 digits.";
            if (!/^\d+$/.test(val)) return "Input must contain only numbers.";
            if (val.includes('0')) return "The number cannot contain zero (0).";
            const uniqueDigits = new Set(val.split(''));
            if (uniqueDigits.size !== 4) return "All digits must be unique.";
            return null;
        };
        const calculateScore = (guess, secret) => {
            let position = 0, count = 0;
            const guessArr = guess.split(''), secretArr = secret.split('');
            guessArr.forEach((d, i) => { if (d === secretArr[i]) position++; });
            guessArr.forEach(d => { if (secret.includes(d)) count++; });
            return { count, position };
        };
        const AVATARS = ['ðŸª™', 'ðŸº', 'ðŸ“œ', 'ðŸ’Ž', 'ðŸš', 'ðŸª”', 'âš”ï¸', 'ðŸ›¡ï¸', 'ðŸ“¿', 'ðŸ¹'];
        const MYTH_NAMES = [["Arjuna", "Bow"], ["Shiva", "Trident"], ["Indra", "Vajra"], ["Rama", "Arrow"], ["Krishna", "Flute"], ["Ganesha", "Tusk"]];
        const generateRoomName = () => { const p = MYTH_NAMES[Math.floor(Math.random() * MYTH_NAMES.length)]; return `${p[0]} ${p[1]}`; };
        const generateRoomId = () => Math.floor(100000 + Math.random() * 900000).toString();

        const copyText = (text, callback) => {
            const fallback = () => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    if (callback) callback();
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                }
                document.body.removeChild(textArea);
            };

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(callback)
                    .catch(err => {
                        console.warn("Async: Could not copy text, trying fallback: ", err);
                        fallback();
                    });
            } else {
                fallback();
            }
        };

        // --- COMPONENTS ---

        const RulesModal = ({ onClose }) => (
            <div className="absolute inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={onClose}>
                <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 animate-pop" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-xl text-slate-800 flex items-center gap-2">
                            <Icons.Info className="w-5 h-5 text-indigo-500" /> Game Rules
                        </h3>
                        <button onClick={onClose} className="text-slate-400 hover:text-slate-600 p-1">âœ•</button>
                    </div>
                    <ul className="space-y-3 text-sm text-slate-600 list-disc pl-4">
                        <li>The computer (or room) picks a secret 4-digit number.</li>
                        <li>Digits are <strong>1 to 9</strong>. No zeroes. No repeating digits.</li>
                        <li><strong>Count:</strong> Number of all correct digits in your guess.</li>
                        <li><strong>Position:</strong> Number of correct digits in the <strong>exact</strong> right position.</li>
                        <li className="pt-2 text-indigo-700 font-semibold">Multiplayer: First player to guess the number wins!</li>
                    </ul>
                    <button onClick={onClose} className="w-full mt-6 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-bold py-3 rounded-xl transition-colors">
                        Got it!
                    </button>
                </div>
            </div>
        );

        const App = () => {
            const [view, setView] = useState('init');
            const [user, setUser] = useState(null);
            const [roomData, setRoomData] = useState(null);
            const [lobbyInitialMode, setLobbyInitialMode] = useState('menu');

            useEffect(() => {
                const initSupabase = () => {
                    if (window.supabase && window.supabase.createClient) {
                        try {
                            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                            let localUid = localStorage.getItem('nm_user_uid');
                            if (!localUid) {
                                localUid = 'u-' + Math.random().toString(36).substr(2, 9);
                                localStorage.setItem('nm_user_uid', localUid);
                            }
                            setUser({ uid: localUid });
                            setView('home');
                        } catch(e) {
                            console.error("Initialization error:", e);
                        }
                    } else {
                        setTimeout(initSupabase, 100);
                    }
                };
                initSupabase();
            }, []);

            const goHome = () => { setView('home'); setRoomData(null); };

            if (view === 'init') return <div className="min-h-screen flex items-center justify-center text-slate-500 font-sans animate-pulse">Initializing Game...</div>;
            
            return (
                <div className="min-h-screen w-full flex flex-col items-center justify-start p-4 font-sans text-slate-800" style={{ backgroundColor: '#E6E6FA' }}>
                    {view === 'home' && <HomeView setView={setView} setLobbyMode={setLobbyInitialMode} />}
                    {view === 'single' && <SinglePlayerGame onBack={goHome} />}
                    {view === 'lobby' && user && <LobbyView user={user} initialMode={lobbyInitialMode} onBack={goHome} onJoin={(data) => { setRoomData(data); setView('multiplayer'); }} />}
                    {view === 'multiplayer' && user && roomData && <MultiplayerGame user={user} initialRoomData={roomData} onLeave={goHome} />}
                </div>
            );
        };

        const HomeView = ({ setView, setLobbyMode }) => (
            <div className="w-full max-w-md animate-fade-in mt-10">
                <header className="text-center mb-10">
                    <h1 className="text-4xl font-bold text-slate-800 mb-2 tracking-tight">Number Mind</h1>
                    <p className="text-slate-600">Crack the code. Challenge friends.</p>
                </header>
                <div className="space-y-4">
                    <button onClick={() => setView('single')} className="w-full bg-white hover:bg-indigo-50 p-6 rounded-2xl shadow-lg border-2 border-transparent hover:border-indigo-200 transition-all group flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <div className="bg-indigo-100 p-3 rounded-full text-indigo-600 group-hover:scale-110 transition-transform"><Icons.User className="w-6 h-6" /></div>
                            <div className="text-left"><h3 className="font-bold text-lg text-slate-800">Play Solo</h3><p className="text-xs text-slate-500">Practice solo</p></div>
                        </div>
                        <Icons.Play className="w-5 h-5 text-indigo-300" />
                    </button>
                    <button onClick={() => { setLobbyMode('create'); setView('lobby'); }} className="w-full bg-white hover:bg-purple-50 p-6 rounded-2xl shadow-lg border-2 border-transparent hover:border-purple-200 transition-all group flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <div className="bg-purple-100 p-3 rounded-full text-purple-600 group-hover:scale-110 transition-transform"><Icons.PlusSquare className="w-6 h-6" /></div>
                            <div className="text-left"><h3 className="font-bold text-lg text-slate-800">Create Room</h3><p className="text-xs text-slate-500">Host a game online</p></div>
                        </div>
                        <Icons.ArrowLeft className="w-5 h-5 text-purple-300 rotate-180" />
                    </button>
                    <button onClick={() => { setLobbyMode('join'); setView('lobby'); }} className="w-full bg-white hover:bg-teal-50 p-6 rounded-2xl shadow-lg border-2 border-transparent hover:border-teal-200 transition-all group flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <div className="bg-teal-100 p-3 rounded-full text-teal-600 group-hover:scale-110 transition-transform"><Icons.Users className="w-6 h-6" /></div>
                            <div className="text-left"><h3 className="font-bold text-lg text-slate-800">Join Room</h3><p className="text-xs text-slate-500">Join via code</p></div>
                        </div>
                        <Icons.LogIn className="w-5 h-5 text-teal-300" />
                    </button>
                </div>
            </div>
        );

        const SinglePlayerGame = ({ onBack }) => {
            const [secret, setSecret] = useState(generateSecretNumber());
            const [history, setHistory] = useState([]);
            const [guess, setGuess] = useState('');
            const [won, setWon] = useState(false);
            const [error, setError] = useState('');
            const [showRules, setShowRules] = useState(false);
            const inputRef = useRef(null);

            const handleGuess = (e) => {
                e.preventDefault();
                const err = validateInput(guess);
                if(err) { setError(err); return; }
                setError('');
                const score = calculateScore(guess, secret);
                const newEntry = { guess, ...score, round: history.length + 1 };
                setHistory([newEntry, ...history]);
                setGuess('');
                if (score.position === 4) setWon(true);
            };

            return (
                <div className="w-full max-w-md animate-fade-in flex flex-col h-[90vh] relative">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center">
                            <button onClick={onBack} className="p-2 hover:bg-white/50 rounded-full transition-colors mr-2"><Icons.Home className="w-6 h-6 text-slate-700" /></button>
                            <h2 className="text-xl font-bold">Single Player</h2>
                        </div>
                        <button onClick={() => setShowRules(true)} className="p-2 text-indigo-600 hover:bg-white/50 rounded-full transition-colors">
                            <Icons.Info className="w-6 h-6" />
                        </button>
                    </div>
                    <GameInterface history={history} won={won} onRestart={() => { setSecret(generateSecretNumber()); setHistory([]); setWon(false); setGuess(''); }} secret={secret} inputProps={{ value: guess, onChange: (e) => { if(e.target.value==='' || /^\d+$/.test(e.target.value)) setGuess(e.target.value.slice(0,4)); }, onSubmit: handleGuess, error, disabled: won, ref: inputRef, placeholder: "1234" }} />
                    
                    {showRules && <RulesModal onClose={() => setShowRules(false)} />}
                </div>
            );
        };

        const LobbyView = ({ user, initialMode, onBack, onJoin }) => {
            const [mode, setMode] = useState(initialMode === 'create' ? 'loading' : 'join');
            const [roomId, setRoomId] = useState('');
            const [name, setName] = useState('');
            const [cId, setCId] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [isSpectator, setIsSpectator] = useState(false);
            const [copied, setCopied] = useState(false);

            useEffect(() => { if(initialMode === 'create') setupCreate(); }, [initialMode]);

            const setupCreate = async () => {
                const nid = generateRoomId();
                const newRoom = { 
                    room_id: nid, 
                    room_name: generateRoomName(), 
                    secret_number: generateSecretNumber(), 
                    status: 'waiting', 
                    players: [], 
                    current_turn_index: 0,
                    winner_id: null
                };
                const { error } = await supabaseClient.from('rooms').insert(newRoom);
                if (error) { console.error(error); setError("Failed to create room."); setMode('join'); return; }
                setCId(nid); setMode('create-name');
            };

            const enterRoom = async () => {
                if(!name.trim()) return;
                setLoading(true);
                const tid = cId || roomId;
                const { data: room, error: fetchError } = await supabaseClient.from('rooms').select().eq('room_id', tid).single();
                if (fetchError || !room) { setError("Room not found"); setLoading(false); return; }

                const exists = room.players.find(p => p.id === user.uid);
                let updatedPlayers = room.players;
                if(!exists) {
                    const np = { 
                        id: user.uid, 
                        name: name.trim().slice(0, 20), 
                        avatar: AVATARS[Math.floor(Math.random()*AVATARS.length)], 
                        guesses: [], 
                        joinedAt: Date.now(),
                        role: isSpectator ? 'spectator' : 'player'
                    };
                    updatedPlayers = [...room.players, np];
                    await supabaseClient.from('rooms').update({ players: updatedPlayers }).eq('room_id', tid);
                } else {
                    if (exists.role !== (isSpectator ? 'spectator' : 'player')) {
                         updatedPlayers = room.players.map(p => p.id === user.uid ? { ...p, role: isSpectator ? 'spectator' : 'player' } : p);
                         await supabaseClient.from('rooms').update({ players: updatedPlayers }).eq('room_id', tid);
                    }
                }
                onJoin({ ...room, players: updatedPlayers });
                setLoading(false);
            };

            const copy = () => {
                copyText(cId, () => { setCopied(true); setTimeout(() => setCopied(false), 2000); });
            };

            if(mode === 'loading') return <div className="h-screen flex items-center justify-center animate-pulse">Creating...</div>;
            
            const isJoin = mode === 'join';
            return (
                <div className="w-full max-w-md animate-fade-in mt-10 p-6 bg-white rounded-2xl shadow-xl relative">
                    {/* Back Button - Present in both modes */}
                    <button onClick={onBack} className="absolute top-4 left-4 p-2 hover:bg-slate-100 rounded-full"><Icons.ArrowLeft className="w-5 h-5 text-slate-500" /></button>
                    
                    <h2 className="text-2xl font-bold text-center mb-6 text-slate-800">{isJoin ? 'Join Room' : 'Room Created!'}</h2>
                    
                    {!isJoin && <div className="bg-slate-50 p-4 rounded-xl mb-6 border border-slate-200">
                        <p className="text-xs text-slate-500 uppercase tracking-wider mb-1">Room ID</p>
                        <div className="flex items-center justify-between">
                            <span className="text-3xl font-mono font-bold text-indigo-600 tracking-widest">{cId}</span>
                            <div className="relative">
                                <button onClick={copy} className="p-2 hover:bg-indigo-100 text-indigo-600 rounded-full"><Icons.Copy className="w-5 h-5" /></button>
                                {copied && <span className="absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-[10px] px-2 py-1 rounded animate-pop whitespace-nowrap">Copied!</span>}
                            </div>
                        </div>
                    </div>}

                    <div className="space-y-4">
                        {isJoin && <div><label className="block text-sm font-medium text-slate-700 mb-1">Room ID</label><input type="tel" maxLength={6} value={roomId} onChange={e=>setRoomId(e.target.value.replace(/\D/g,''))} placeholder="6-digit code" className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-indigo-500 outline-none font-mono text-lg text-center"/></div>}
                        <div><label className="block text-sm font-medium text-slate-700 mb-1">Your Name</label><input type="text" maxLength={20} value={name} onChange={e=>setName(e.target.value)} placeholder="Enter name" className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-indigo-500 outline-none"/></div>
                        
                        {/* Spectator Toggle */}
                        <div className="flex items-center gap-2 p-3 bg-slate-50 rounded-xl border border-slate-100">
                            <input type="checkbox" id="specMode" checked={isSpectator} onChange={e=>setIsSpectator(e.target.checked)} className="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500" />
                            <label htmlFor="specMode" className="text-sm text-slate-700 font-medium flex items-center gap-2">
                                <Icons.Eye className="w-4 h-4 text-slate-500" /> Join as Spectator
                            </label>
                        </div>

                        {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                        <button onClick={enterRoom} disabled={!name || (isJoin && roomId.length!==6) || loading} className={`w-full text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 ${isJoin?'bg-teal-600 hover:bg-teal-700':'bg-indigo-600 hover:bg-indigo-700'} disabled:bg-slate-300`}>{loading ? 'Loading...' : (isJoin ? 'Join Room' : 'Enter Room')}</button>
                    </div>
                </div>
            );
        };

        const MultiplayerGame = ({ user, initialRoomData, onLeave }) => {
            const [room, setRoom] = useState(initialRoomData);
            const [guess, setGuess] = useState('');
            const [error, setError] = useState('');
            const [showList, setShowList] = useState(false);
            const [showRules, setShowRules] = useState(false);
            const [specId, setSpecId] = useState(null);
            const [winner, setWinner] = useState(null);
            const [copied, setCopied] = useState(false);

            useEffect(() => {
                if(!room?.room_id) return;
                const subscription = supabaseClient.channel('public:rooms').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `room_id=eq.${room.room_id}` }, (payload) => {
                    setRoom(payload.new);
                    if (payload.new.status === 'won') setWinner(payload.new.players.find(p => p.id === payload.new.winner_id));
                }).subscribe();
                return () => supabaseClient.removeChannel(subscription);
            }, [room?.room_id]);

            const copyId = () => copyText(room.room_id, () => { setCopied(true); setTimeout(() => setCopied(false), 2000); });

            const handleLeave = async () => {
                const ups = room.players.filter(p => p.id !== user.uid);
                const activePlayers = room.players.filter(p => p.role !== 'spectator');
                const remainingActive = ups.filter(p => p.role !== 'spectator');
                let idx = room.current_turn_index;
                if (remainingActive.length > 0 && idx >= remainingActive.length) idx = 0;
                
                await supabaseClient.from('rooms').update({ players: ups, current_turn_index: idx }).eq('room_id', room.room_id);
                onLeave();
            };

            const activePlayers = useMemo(() => room.players.filter(p => p.role !== 'spectator'), [room.players]);
            const myPlayer = room.players.find(p => p.id === user.uid);
            const amISpectator = myPlayer?.role === 'spectator';
            const currentPlayer = activePlayers[room.current_turn_index];
            const isMyTurn = currentPlayer?.id === user.uid && room.status !== 'won';
            const displayedPlayerId = specId || user.uid;
            const displayedPlayer = room.players.find(p => p.id === displayedPlayerId);
            const isViewingOther = displayedPlayerId !== user.uid;

            const submit = async (e) => {
                e.preventDefault();
                if(!isMyTurn) return;
                const err = validateInput(guess); if(err) { setError(err); return; } setError('');
                
                const sc = calculateScore(guess, room.secret_number);
                const ne = { guess, ...sc, round: myPlayer.guesses.length + 1 };
                const ups = room.players.map(p => p.id === user.uid ? { ...p, guesses: [ne, ...p.guesses] } : p);
                
                let updates = {};
                if(sc.position === 4) {
                    updates = { players: ups, status: 'won', winner_id: user.uid };
                } else {
                    const nextIndex = (room.current_turn_index + 1) % activePlayers.length;
                    updates = { players: ups, current_turn_index: nextIndex };
                }

                await supabaseClient.from('rooms').update(updates).eq('room_id', room.room_id);
                setGuess('');
            };

            const restart = async () => {
                const ns = generateSecretNumber();
                const rps = room.players.map(p => ({...p, guesses: []}));
                const updates = { secret_number: ns, players: rps, status: 'playing', winner_id: null, current_turn_index: 0 };
                await supabaseClient.from('rooms').update(updates).eq('room_id', room.room_id);
                setWinner(null);
            };

            const placeholderText = isMyTurn ? "Your Turn" : (currentPlayer ? `${currentPlayer.name}'s turn` : "Waiting...");
            const headerText = isViewingOther ? `${displayedPlayer?.name}'s View` : (room.status==='won'?'Game Over':placeholderText);

            return (
                <div className="w-full max-w-md animate-fade-in flex flex-col h-[95vh] relative">
                    <div className="flex items-center justify-between mb-2 bg-indigo-600 p-3 rounded-t-xl shadow-md text-white">
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-medium opacity-80 uppercase">Room:</span>
                            <span className="font-mono font-bold tracking-wider text-lg">{room.room_id}</span>
                        </div>
                        <div className="relative">
                            <button onClick={copyId} className="p-1.5 hover:bg-white/20 rounded-md transition-colors"><Icons.Copy className="w-4 h-4" /></button>
                            {copied && <span className="absolute top-8 right-0 bg-black text-white text-[10px] px-2 py-1 rounded animate-pop whitespace-nowrap">Copied!</span>}
                        </div>
                    </div>

                    <div className="flex items-center justify-between mb-4 bg-white p-3 rounded-b-xl shadow-sm border-x border-b border-slate-100">
                        <button onClick={handleLeave} className="p-2 hover:bg-slate-100 rounded-full text-slate-600"><Icons.Home className="w-6 h-6" /></button>
                        <div className="text-center">
                            <h2 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{room.room_name}</h2>
                            <p className={`font-bold ${isMyTurn ? 'text-indigo-600' : 'text-slate-800'}`}>{headerText}</p>
                        </div>
                        <div className="flex items-center gap-1">
                            <button onClick={() => setShowRules(true)} className="p-2 text-indigo-600 hover:bg-slate-100 rounded-full transition-colors">
                                <Icons.Info className="w-6 h-6" />
                            </button>
                            <button onClick={() => setShowList(true)} className="relative p-2 hover:bg-slate-100 rounded-full text-slate-600">
                                <Icons.Users className="w-6 h-6" />
                                <span className="absolute -top-1 -right-1 bg-indigo-600 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border-2 border-white">{room.players.length}</span>
                            </button>
                        </div>
                    </div>

                    {isViewingOther && (
                        <div className="mb-2 bg-indigo-100 text-indigo-800 px-4 py-2 rounded-lg text-sm flex justify-between items-center">
                            <span>Watching <strong>{displayedPlayer?.name}</strong></span>
                            <button onClick={()=>setSpecId(null)} className="font-bold hover:underline">Back to me</button>
                        </div>
                    )}

                    <GameInterface 
                        history={displayedPlayer?.guesses || []} 
                        won={!!winner} 
                        winnerName={winner?.name} 
                        isMultiplayer={true} 
                        isMyTurn={isMyTurn} 
                        isSpectating={amISpectator || isViewingOther}
                        onRestart={restart} 
                        secret={room.secret_number} 
                        inputProps={{ 
                            value: guess, 
                            onChange: e => {if(e.target.value===''||/^\d+$/.test(e.target.value)) setGuess(e.target.value.slice(0,4))}, 
                            onSubmit: submit, 
                            error, 
                            disabled: !isMyTurn || room.status === 'won',
                            placeholder: placeholderText
                        }} 
                    />

                    {showList && (
                        <div className="absolute inset-0 bg-black/50 backdrop-blur-sm z-50 flex pt-20 justify-center" onClick={()=>setShowList(false)}>
                            <div className="bg-white w-11/12 max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-slide-up" onClick={e=>e.stopPropagation()}>
                                <div className="p-4 border-b flex justify-between bg-slate-50 items-center">
                                    <h3 className="font-bold text-lg text-slate-800">Players</h3>
                                    <button onClick={()=>setShowList(false)} className="text-slate-400 hover:text-slate-600">âœ•</button>
                                </div>
                                <div className="max-h-[60vh] overflow-y-auto">
                                    {room.players.map((p, i) => {
                                        const isActive = p.role !== 'spectator';
                                        const isTurn = isActive && currentPlayer?.id === p.id && !winner;
                                        return (
                                            <div 
                                                key={p.id} 
                                                onClick={() => {
                                                    if (amISpectator || p.id === user.uid) {
                                                        setSpecId(p.id === user.uid ? null : p.id); 
                                                        setShowList(false);
                                                    }
                                                }} 
                                                className={`p-4 flex items-center gap-3 border-b border-slate-50 transition-colors 
                                                    ${(amISpectator || p.id === user.uid) ? 'cursor-pointer hover:bg-indigo-50' : 'cursor-default opacity-80'}
                                                    ${isTurn ? 'bg-indigo-50/60' : ''}
                                                `}
                                            >
                                                <div className="text-2xl">{p.avatar}</div>
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2">
                                                        <span className={`font-bold ${p.id===user.uid?'text-indigo-600':'text-slate-700'}`}>
                                                            {p.name} {p.id===user.uid&&'(You)'}
                                                        </span>
                                                        {isTurn && <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>}
                                                        {p.role === 'spectator' && <Icons.Eye className="w-3 h-3 text-slate-400" />}
                                                    </div>
                                                    <p className="text-xs text-slate-400">{isActive ? `${p.guesses.length} moves` : 'Spectator'}</p>
                                                </div>
                                                {isTurn && <span className="text-xs font-bold text-green-600">Turn</span>}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {showRules && <RulesModal onClose={() => setShowRules(false)} />}
                </div>
            );
        };

        const GameInterface = ({ history, won, winnerName, onRestart, secret, inputProps, isMultiplayer=false, isMyTurn=true, isSpectating=false }) => {
            return (
                <div className="w-full flex-1 flex flex-col overflow-hidden bg-white/50 rounded-2xl border border-white/60 shadow-xl backdrop-blur-sm">
                    <div className="p-4 bg-white border-b border-indigo-100">
                        {won ? (
                            <div className="text-center py-4 animate-fade-in">
                                <div className="mx-auto bg-green-100 w-14 h-14 rounded-full flex items-center justify-center mb-3"><Icons.Trophy className="w-7 h-7 text-green-600" /></div>
                                <h2 className="text-xl font-bold text-green-700 mb-1">{isMultiplayer ? `${winnerName} Won!` : 'You Won!'}</h2>
                                <p className="text-sm text-slate-600 mb-4">Code: <strong>{secret}</strong></p>
                                {(isMultiplayer && !isSpectating) || !isMultiplayer ? 
                                    <button onClick={onRestart} className="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-full shadow-lg text-sm flex items-center gap-2 mx-auto"><Icons.RefreshCw className="w-4 h-4" /> Play Again</button> 
                                    : <p className="text-xs text-slate-500">Waiting for host to restart...</p>
                                }
                            </div>
                        ) : (
                            isSpectating ? 
                            <div className="h-20 flex flex-col items-center justify-center text-slate-400 italic text-sm border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50">
                                <Icons.Eye className="w-5 h-5 mb-1 opacity-50" />
                                <span>{inputProps.placeholder === "Your Turn" ? "Spectating Board" : (inputProps.placeholder.includes("Waiting") ? "Spectating..." : inputProps.placeholder)}</span>
                            </div> 
                            :
                            <form onSubmit={inputProps.onSubmit} className="flex flex-col gap-3">
                                <div className="relative">
                                    <input 
                                        ref={inputProps.ref} 
                                        type="tel" 
                                        value={inputProps.value} 
                                        onChange={inputProps.onChange} 
                                        placeholder={inputProps.placeholder} 
                                        disabled={inputProps.disabled} 
                                        className={`w-full text-center text-2xl tracking-[0.5em] font-mono py-3 border-2 rounded-xl focus:outline-none focus:ring-4 focus:ring-indigo-500 transition-colors placeholder:text-xs placeholder:text-slate-400 placeholder:tracking-normal ${inputProps.error ? 'border-red-400 bg-red-50' : 'border-indigo-100 bg-slate-50'}`} 
                                        maxLength={4} 
                                    />
                                </div>
                                {inputProps.error && <div className="flex items-center gap-2 text-red-600 text-xs bg-red-50 p-2 rounded-lg animate-fade-in"><Icons.AlertCircle className="w-3 h-3" /><span>{inputProps.error}</span></div>}
                                <button type="submit" disabled={!inputProps.value || inputProps.disabled} className="w-full bg-indigo-600 disabled:bg-slate-300 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-md flex items-center justify-center gap-2">
                                    <Icons.Play className="w-4 h-4 fill-current" /> 
                                    {isMultiplayer ? (isMyTurn ? "Submit Guess" : inputProps.placeholder) : "Guess"}
                                </button>
                            </form>
                        )}
                    </div>
                    <div className="grid grid-cols-4 bg-indigo-50 p-2 text-[10px] font-bold text-indigo-900 uppercase tracking-wider text-center border-b border-indigo-100"><div>#</div><div>Input</div><div>Count</div><div>Position</div></div>
                    <div className="overflow-y-auto flex-1 p-0 custom-scrollbar bg-white">
                        {history.length === 0 ? <div className="h-full flex items-center justify-center text-slate-300 text-sm">No guesses yet</div> : history.map((row) => (
                            <div key={row.round} className={`grid grid-cols-4 p-3 text-center border-b border-slate-50 text-sm animate-fade-in ${row.position === 4 ? 'bg-green-50' : 'even:bg-white odd:bg-slate-50/50'}`}>
                                <div className="text-slate-400 font-mono">#{row.round}</div><div className="font-mono font-semibold text-slate-700 tracking-widest">{row.guess}</div><div className="text-blue-600"><span className="bg-blue-100 px-2 py-0.5 rounded-full text-xs">{row.count}</span></div><div className="text-indigo-700"><span className={`px-2 py-0.5 rounded-full text-xs ${row.position === 4 ? 'bg-green-200 text-green-800' : 'bg-indigo-100'}`}>{row.position}</span></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
